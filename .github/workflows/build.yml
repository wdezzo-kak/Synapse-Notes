name: Build and Deploy Extension

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Configure npm to use runner-temp cache
        run: |
          # Use a per-runner temporary cache so cleans are reliable
          npm config set cache "$RUNNER_TEMP/npm-cache" --global
          npm cache clean --force || true
          rm -rf "$RUNNER_TEMP/npm-cache" || true
          # Optional quick verify (won't fail the job)
          npm cache verify || true

      - name: Install dependencies (npm ci) with retries
        run: |
          set -euo pipefail
          retries=3
          count=0
          until [ $count -ge $retries ]; do
            if npm ci --prefer-offline --no-audit --no-fund; then
              echo "npm ci succeeded"
              break
            fi
            count=$((count+1))
            echo "npm ci failed â€” retrying ($count/$retries)..."
            sleep 5
          done
          if [ $count -ge $retries ]; then
            echo "npm ci failed after $retries attempts; saving debug logs"
            # Save npm debug log for investigation
            mkdir -p $GITHUB_WORKSPACE/npm-debug-logs || true
            cp -v /home/runner/.npm/_logs/*.log $GITHUB_WORKSPACE/npm-debug-logs/ || true
            ls -la "$RUNNER_TEMP/npm-cache" || true
            exit 1
          fi

      - name: Build extension
        run: npm run build

      - name: Prepare dist folder
        run: |
          # Copy static files that Vite might not catch
          cp manifest.json dist/
          if [ -f icon.png ]; then cp icon.png dist/; fi
          # Ensure README and GUIDE are in the build branch too
          cp README.md dist/
          cp GUIDE.md dist/
      - name: Create Zip Artifact
        run: |
          cd dist
          zip -r ../synapse-notes-production.zip .
          cd ..
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: synapse-notes-v${{ github.run_number }}
          path: synapse-notes-production.zip

      - name: Deploy to Extension-Dist Branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: extension-dist
          clean: true
          commit-message: "deploy: build v${{ github.run_number }} [skip ci]"
